#!/usr/bin/env ruby

######################################################################
#  Copyright (c) 2008-2016, Alliance for Sustainable Energy.
#  All rights reserved.
#
#  This library is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public
#  License as published by the Free Software Foundation; either
#  version 2.1 of the License, or (at your option) any later version.
#
#  This library is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#  Lesser General Public License for more details.
#
#  You should have received a copy of the GNU Lesser General Public
#  License along with this library; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
######################################################################

::Signal.trap('INT') { abort }

require 'optparse'

options = {debug: false}
::OptionParser.new do |opts|
  opts.banner = 'Usage: mongo_daemon [options]'

  opts.on('-p', '--port NUMBER', 'Port to start mongo on') { |p| options[:port] = p }
  opts.on('-l', '--log path', 'Directory to write the mongo log to') { |l| options[:log_path] = l }
  opts.on('-i', '--invocation DIRECTORY', 'Directory to invoke mongo from') { |i| options[:invocation] = i }
  opts.on('-d', '--database DIRECTORY', 'Directory for the mongod instance database') { |d| options[:dbpath] = d }
  opts.on('-w', '--windows', 'Flag to indicate running on Windows') { |w| options[:windows] = true }
  opts.on('--debug', 'Print debugging information to STDOUT') { |_| options[:debug] = true}

end.parse!

::Dir.chdir(File.absolute_path(options[:invocation]))
if options[:windows]
  sys_call = "mongod.exe --port #{options[:port]} --logpath \"#{options[:log_path]}/mongo.log\" --dbpath \"#{options[:dbpath]}\""
else
  sys_call = "mongod --port #{options[:port]} --logpath #{options[:log_path]}/mongo.log --dbpath #{options[:dbpath]}"
end
puts "System call will be: '#{sys_call}' in directory '#{Dir.pwd}'" if options[:debug]

exec sys_call
