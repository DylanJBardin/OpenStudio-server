#!/usr/bin/env ruby

######################################################################
#  Copyright (c) 2008-2016, Alliance for Sustainable Energy.
#  All rights reserved.
#
#  This library is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public
#  License as published by the Free Software Foundation; either
#  version 2.1 of the License, or (at your option) any later version.
#
#  This library is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#  Lesser General Public License for more details.
#
#  You should have received a copy of the GNU Lesser General Public
#  License along with this library; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
######################################################################

::Signal.trap('INT') { abort }

require 'optparse'

options = {debug: false}
::OptionParser.new do |opts|
  opts.banner = 'Usage: mongo_daemon [options]'

  opts.on('-p', '--port NUMBER', 'Port to start rails on') { |p| options[:port] = p }
  opts.on('-r', '--project DIRECTORY', 'PAT project DIRECTORY') { |r| options[:project] = r }
  opts.on('-l', '--log path', 'Directory to write the rails log to') { |l| options[:logfile] = l }
  opts.on('-d', '--database PORT', 'Port for the mongod instance') { |d| options[:dbport] = d }
  opts.on('--debug', 'Print debugging information to STDOUT') { |_| options[:debug] = true}

end.parse!

local_pid_file = File.join(options[:project], 'server.pid')
bundle_path = File.absolute_path(File.join(__FILE__, './../../../../gems/bin/bundle'))
rails_path = File.absolute_path(File.join(__FILE__, './../../../../gems/bin/rails'))
::Dir.chdir(File.absolute_path(File.join(__FILE__, './../../../../server')))
::ENV['OS_SERVER_MONGO_PORT'] = options[:dbport]
::ENV['OS_SERVER_DATABASE_NAME'] = 'os_local'
::ENV['OS_SERVER_LOG_PATH'] = options[:logfile]
::ENV['OS_SERVER_HOST_URL'] = 'http://localhost:' + options[:port]
::ENV['RAILS_ENV'] = 'local'
sys_call = "\"#{bundle_path}\" exec \"#{rails_path}\" s -p #{options[:port]} -P #{local_pid_file}"

puts "System call will be: '#{sys_call}' in directory '#{Dir.pwd}'" if options[:debug]
puts "ENV for starting rails: #{::ENV.inspect}" if options[:debug]

exec sys_call
